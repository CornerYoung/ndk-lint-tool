"use strict";var _interopRequireDefault=require("@babel/runtime-corejs2/helpers/interopRequireDefault");var _Object$defineProperty=require("@babel/runtime-corejs2/core-js/object/define-property");_Object$defineProperty(exports,"__esModule",{value:true});exports.check=void 0;var _objectSpread2=_interopRequireDefault(require("@babel/runtime-corejs2/helpers/objectSpread"));var _regenerator=_interopRequireDefault(require("@babel/runtime-corejs2/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime-corejs2/helpers/asyncToGenerator"));var _ndkUtilities=require("@nuofe/ndk-utilities");var _crossSpawn=_interopRequireDefault(require("cross-spawn"));var _fs=_interopRequireDefault(require("fs"));var _path=_interopRequireDefault(require("path"));var TYPE_MAP={app:"@nuofe/eslint-config-react-app",web:"@nuofe/eslint-config-react-desktop"};var getName=function getName(type){var name=TYPE_MAP[type];if(!name){console.log();console.log("[i] \u5F53\u524D\u5305\u7C7B\u578B\u6CA1\u6709\u53EF\u7528\u7684 lint \u5DE5\u5177\u3002");process.exit(1)}return name};var getRcContent=function getRcContent(name){return"module.exports = {\n    extends: '".concat(name,"',\n    rules: {\n        'no-console': process.env.NODE_ENV === 'production' ? 'error' : 'off',\n        'no-debugger': process.env.NODE_ENV === 'production' ? 'error' : 'off',\n    }\n};\n")};var checkConfig=function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(options){var cwd,_options$ndkConfig,ndkConfig,packageInfo,_ndkConfig$type,type,rcContent,rcFiles,rcJsFile,rcJsPath;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:cwd=options.cwd,_options$ndkConfig=options.ndkConfig,ndkConfig=_options$ndkConfig===void 0?{}:_options$ndkConfig,packageInfo=options.packageInfo;_ndkConfig$type=ndkConfig.type,type=_ndkConfig$type===void 0?"":_ndkConfig$type;rcContent=getRcContent(getName(type));rcFiles=[".eslintrc",".eslintc.json"];rcJsFile=".eslintrc.js";rcJsPath=_path["default"].resolve(cwd,rcJsFile);rcFiles.map(function(rcFile){var rcPath=_path["default"].resolve(cwd,rcFile);if(_fs["default"].existsSync(rcPath)){_fs["default"].unlinkSync(rcPath);console.log("\u5220\u9664 ".concat(rcFile," \u6587\u4EF6\u3002"))}});if(packageInfo.eslintConfig){delete packageInfo.eslintConfig;_ndkUtilities.Options.updatePackage(options);console.log("\u5220\u9664 eslintConfig \u914D\u7F6E\u3002")}_fs["default"].writeFileSync(rcJsPath,rcContent,"utf8");console.log("\u66F4\u65B0 ".concat(rcJsFile," \u6587\u4EF6\u6210\u529F\u3002"));case 10:case"end":return _context.stop();}}},_callee)}));return function checkConfig(_x){return _ref.apply(this,arguments)}}();var checkDependencies=function(){var _ref2=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee2(options){var cwd,_options$ndkConfig2,ndkConfig,packageInfo,_ndkConfig$type2,type,name,_packageInfo$dependen,dependencies,_packageInfo$devDepen,devDependencies,showTip,_spawn$sync,status,_spawn$sync2,_status;return _regenerator["default"].wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:cwd=options.cwd,_options$ndkConfig2=options.ndkConfig,ndkConfig=_options$ndkConfig2===void 0?{}:_options$ndkConfig2,packageInfo=options.packageInfo;_ndkConfig$type2=ndkConfig.type,type=_ndkConfig$type2===void 0?"":_ndkConfig$type2;name=getName(type);_packageInfo$dependen=packageInfo.dependencies,dependencies=_packageInfo$dependen===void 0?{}:_packageInfo$dependen,_packageInfo$devDepen=packageInfo.devDependencies,devDependencies=_packageInfo$devDepen===void 0?{}:_packageInfo$devDepen;showTip=true;if(!devDependencies[name]){showTip=false;console.log();_spawn$sync=_crossSpawn["default"].sync("yarn",["add",name,"--dev"],{cwd:cwd,stdio:"inherit"}),status=_spawn$sync.status;if(status!==0){console.log();console.log("[i] \u4F9D\u8D56\u5305 ".concat(name," \u5B89\u88C5\u5931\u8D25\uFF0C\u8BF7\u7A0D\u5019\u91CD\u65B0\u6267\u884C\u547D\u4EE4\uFF01"));process.exit(1)}}if(!(dependencies.eslint||devDependencies.eslint)){showTip=false;console.log();_spawn$sync2=_crossSpawn["default"].sync("yarn",["add","eslint","--dev"],{cwd:cwd,stdio:"inherit"}),_status=_spawn$sync2.status;if(_status!==0){console.log();console.log("[i] \u4F9D\u8D56\u5305 eslint \u5B89\u88C5\u5931\u8D25\uFF0C\u8BF7\u7A0D\u5019\u91CD\u65B0\u6267\u884C\u547D\u4EE4\uFF01");process.exit(1)}}if(showTip){console.log("\u4F9D\u8D56\u5305\u5DF2\u5B89\u88C5\u3002")}else{_ndkUtilities.Options.reloadPackage(options)}case 8:case"end":return _context2.stop();}}},_callee2)}));return function checkDependencies(_x2){return _ref2.apply(this,arguments)}}();var checkScripts=function(){var _ref3=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee3(options){var packageInfo,_packageInfo$scripts,scripts,_scripts$lint,lint,lintScript;return _regenerator["default"].wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:packageInfo=options.packageInfo;_packageInfo$scripts=packageInfo.scripts,scripts=_packageInfo$scripts===void 0?{}:_packageInfo$scripts;_scripts$lint=scripts.lint,lint=_scripts$lint===void 0?"":_scripts$lint;lintScript="eslint --fix ./src/";if(!lint||lint!==lintScript){packageInfo.scripts=(0,_objectSpread2["default"])({},scripts,{lint:lintScript});_ndkUtilities.Options.updatePackage(options)}else{console.log("\u547D\u4EE4\u6B63\u5E38\u3002")}case 5:case"end":return _context3.stop();}}},_callee3)}));return function checkScripts(_x3){return _ref3.apply(this,arguments)}}();var check=function(){var _ref4=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee4(options){return _regenerator["default"].wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:console.log("> eslintrc.js check:");_context4.next=3;return checkConfig(options);case 3:console.log();console.log("> dependencies check:");_context4.next=7;return checkDependencies(options);case 7:console.log();console.log("> scripts check:");_context4.next=11;return checkScripts(options);case 11:case"end":return _context4.stop();}}},_callee4)}));return function check(_x4){return _ref4.apply(this,arguments)}}();exports.check=check;